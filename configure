#!/bin/bash

echo "Configuring Satellite"

#default log path
OS=`uname`
if [ "$OS" = "Darwin" ]; then
logpath="/Users/`whoami`/.satellite/sat.log"
#lets make a satellite folder just incase it doesn't exist
mkdir -p /Users/`whoami`/.satellite
else
logpath="/home/`whoami`/.satellite/sat.log"
#lets make a satellite folder just incase it doesn't exist
mkdir -p /home/`whoami`/.satellite
fi
echo "logpath set to: $logpath"
function setup_conf()
{
	echo "Please enter the hostname (or ip address) for the frontend server"
	read frontend
	echo "Please enter the port for the frontend server"
	read frontendport
	echo "Please enter hostname (or ip address) for sql db"
    read host
    echo "Please enter sql username"
    read user
    echo "Please enter sql password"
    read pass
    echo "Please enter listener port (leave blank for default 9099)"
    read listenport

    if [ -z "$listenport" ]; then
        echo "Using default port"
        listenport=9099
    fi

    cat conf/default.conf | while IFS='' read -r LINE
    do
        if [[ "$LINE" = *sqlhost* ]]; then
            echo "sqlhost=$host" >> conf/satellite.conf
        elif [[ "$LINE" = *sqluser* ]]; then
            echo "sqluser=$user" >> conf/satellite.conf
        elif [[ "$LINE" = *sqlpass* ]]; then
            echo "sqlpass=$pass" >> conf/satellite.conf
        elif [[ "$LINE" = *listenport* ]]; then
            echo "listenport=$listenport" >> conf/satellite.conf
        elif [[ "$LINE" = *logpath* ]]; then
            echo "logpath=$logpath" >> conf/satellite.conf
		elif [[ "$LINE" = *frontendserver* ]]; then
			echo "frontendserver=$frontend" >> conf/satellite.conf
		elif [[ "$LINE" = *frontendport* ]]; then
			echo "frontendport=$frontendport" >> conf/satellite.conf
		else
            echo "$LINE" >> conf/satellite.conf
        fi
    
    done

}
function place_conf()
{
	if [ "$OS" = "Darwin" ]; then
		mv conf/satellite.conf /Users/`whoami`/.satellite
	else
		mv conf/satellite.conf /home/`whoami`/.satellite
	fi
}

if [ -e conf/satellite.conf ]; then
    rm conf/satellite.conf
fi
if [ -e Makefile ]; then
	rm Makefile
fi
if [ -e isotope ]; then
	rm isotope
fi

cat Makefile.in | while IFS='' read -r LINE
do
	echo "$LINE" >> Makefile
done

setup_conf
place_conf
echo "All done!"
echo "Please run make"
